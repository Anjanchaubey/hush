<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Voice Chat</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #ffffff;
        }
        
        #app-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 25px 45px rgba(0, 0, 0, 0.1);
        }
        
        .btn {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(79, 70, 229, 0.4);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }
        
        .btn-danger:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 35px rgba(239, 68, 68, 0.4);
        }
        
        .input-field {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            letter-spacing: 0.5rem;
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: #4f46e5;
            box-shadow: 0 0 20px rgba(79, 70, 229, 0.3);
            transform: scale(1.02);
        }
        
        .input-field::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        h1 {
            background: linear-gradient(45deg, #ffffff, #e0e7ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        #room-status {
            background: linear-gradient(45deg, #10b981, #059669);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        #room-controls {
            gap: 2rem;
        }
        
        #room-controls button {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        #room-controls button svg {
            width: 28px;
            height: 28px;
            transition: all 0.3s ease;
        }
        
        #room-controls button:hover svg {
            transform: scale(1.1);
        }
        
        #participants-count {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            padding: 0.75rem 1.5rem;
            display: inline-block;
            font-weight: 600;
        }
        
        #error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            padding: 0.5rem;
            backdrop-filter: blur(10px);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <div id="app-container" class="w-full max-w-md p-8 space-y-6 rounded-2xl fade-in">

        <!-- Join View: Shown initially to enter a room code -->
        <div id="join-view">
            <h1 class="text-3xl font-bold text-center text-white">Simple Voice Chat</h1>
            <p class="text-center text-gray-400 mt-2">Enter a 4-digit room code to start or join a call.</p>
            <div class="mt-8 space-y-4">
                <div>
                    <input type="text" id="room-id" class="input-field w-full max-w-xs px-4 py-4 rounded-xl" placeholder="1234" maxlength="4" />
                </div>
                <button id="join-btn" class="btn btn-primary w-full px-6 py-4 rounded-xl font-semibold text-white">Join Room</button>
            </div>
            <p id="error-message" class="text-red-400 text-center mt-4 h-5"></p>
        </div>

        <!-- Room View: Shown after joining a room -->
        <div id="room-view" class="hidden">
            <div class="text-center">
                <h2 id="room-status" class="text-xl font-semibold text-white"></h2>
                <p class="text-gray-400">You are now in the voice chat.</p>
            </div>
            
            <div id="room-controls" class="flex justify-center items-center space-x-4 mt-8">
                <!-- Mute/Unmute Button -->
                <button id="mute-btn" class="btn btn-secondary">
                    <svg id="mic-on-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2a3 3 0 0 1 3 3v6a3 3 0 0 1-6 0V5a3 3 0 0 1 3-3z"/>
                        <path d="M19 10v1a7 7 0 0 1-14 0v-1a1 1 0 0 1 2 0v1a5 5 0 0 0 10 0v-1a1 1 0 0 1 2 0z"/>
                        <path d="M12 18.5a1 1 0 0 1 1 1V22a1 1 0 0 1-2 0v-2.5a1 1 0 0 1 1-1z"/>
                    </svg>
                    <svg id="mic-off-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor" class="hidden">
                        <path d="M436.418,244.958v-26.706h-35.395v26.706c-0.021,20.719-4.369,40.396-12.217,58.212l26.432,26.44C428.735,304.384,436.403,275.558,436.418,244.958z"/>
                        <path d="M336.135,244.958V80.124C336.121,35.926,300.209,0.014,256.003,0c-44.184,0.014-80.11,35.926-80.124,80.124v10.119l160.068,160.076C336.063,248.544,336.135,246.769,336.135,244.958z"/>
                        <path d="M393.815,361.087c0.202-0.237,0.431-0.453,0.633-0.69l-25.117-25.125c-0.194,0.244-0.431,0.46-0.626,0.704l-46.311-46.318c0.18-0.259,0.396-0.489,0.568-0.755L175.88,141.843v1.301L84.608,51.873l-25.8,25.793L175.88,194.737v50.22c0.014,44.184,35.94,80.096,80.124,80.11c14.423-0.007,27.928-3.888,39.627-10.579l46.692,46.692c-24.169,18.01-53.914,28.776-86.319,28.776c-40.001,0-76.164-16.228-102.482-42.531c-26.303-26.318-42.531-62.466-42.531-102.468v-26.706H75.597v26.706c0.028,91.494,68.438,167.033,156.828,178.675V512h47.188v-88.367c32.929-4.348,62.998-17.672,87.886-37.277l59.901,59.901l25.793-25.793L393.815,361.087z"/>
                    </svg>
                </button>
                <!-- Hang Up Button -->
                <button id="hangup-btn" class="btn btn-danger">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
                        <path d="M23 12.5 20.5 15l-3-2V8.842C15.976 8.337 14.146 8 12 8c-2.145 0-3.976.337-5.5.842V13l-3 2L1 12.5c.665-.997 2.479-2.657 5.5-3.658C8.024 8.337 9.855 8 12 8c2.146 0 3.976.337 5.5.842 3.021 1 4.835 2.66 5.5 3.658z"/>
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.5 8.842C15.976 8.337 14.146 8 12 8c-2.145 0-3.976.337-5.5.842m11 0c3.021 1 4.835 2.66 5.5 3.658L20.5 15l-3-2V8.842zm-11 0c-3.021 1-4.835 2.66-5.5 3.658L3.5 15l3-2V8.842z"/>
                    </svg>
                </button>
            </div>
             <div id="participants-count" class="text-center text-gray-400 mt-4">Participants: 1</div>
        </div>
        
        <!-- This div will hold the audio elements for remote peers -->
        <div id="remote-audio-container"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc, addDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCYY2GQqS0tCXb7Oxw8AWXhpexq9e8VRUs",
            authDomain: "aspirehub-32863.firebaseapp.com",
            projectId: "aspirehub-32863",
            storageBucket: "aspirehub-32863.appspot.com",
            messagingSenderId: "686810111182",
            appId: "1:686810111182:web:4290b4b1b6e64934ec449f",
            measurementId: "G-KX41R0SSMY",
            databaseURL: "https://aspirehub-32863-default-rtdb.asia-southeast1.firebasedatabase.app"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Generate unique user ID
        const userId = 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        
        // WebRTC configuration
        const servers = {
            iceServers: [
                { urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }
            ]
        };

        // Global variables
        let localStream;
        let isMuted = false;
        let roomId;
        let peerConnection;
        let isOfferer = false;
        let hasProcessedOffer = false;
        let hasProcessedAnswer = false;

        // UI elements
        const joinView = document.getElementById('join-view');
        const roomView = document.getElementById('room-view');
        const joinBtn = document.getElementById('join-btn');
        const roomIdInput = document.getElementById('room-id');
        const muteBtn = document.getElementById('mute-btn');
        const hangupBtn = document.getElementById('hangup-btn');
        const roomStatus = document.getElementById('room-status');
        const errorMessage = document.getElementById('error-message');
        const micOnIcon = document.getElementById('mic-on-icon');
        const micOffIcon = document.getElementById('mic-off-icon');
        const participantsCountEl = document.getElementById('participants-count');

        async function attemptJoinRoom() {
            roomId = roomIdInput.value.trim();
            if (!/^\d{4}$/.test(roomId)) {
                errorMessage.textContent = 'Please enter a valid 4-digit room code.';
                return;
            }
            errorMessage.textContent = '';
            
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                await joinRoom();
                joinView.classList.add('hidden');
                roomView.classList.remove('hidden');
                roomStatus.textContent = `Connected to Room: ${roomId}`;
            } catch (error) {
                console.error("Error:", error);
                errorMessage.textContent = "Could not access microphone or join room.";
            }
        }

        joinBtn.onclick = attemptJoinRoom;
        
        roomIdInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && roomIdInput.value.trim().length === 4) {
                attemptJoinRoom();
            }
        });

        // Mute button
        muteBtn.onclick = () => {
            isMuted = !isMuted;
            localStream.getAudioTracks()[0].enabled = !isMuted;
            micOnIcon.classList.toggle('hidden', isMuted);
            micOffIcon.classList.toggle('hidden', !isMuted);
        };

        // Hang up button
        hangupBtn.onclick = async () => {
            await hangUp();
            roomView.classList.add('hidden');
            joinView.classList.remove('hidden');
            roomIdInput.value = '';
        };

        async function joinRoom() {
            const roomRef = doc(db, 'rooms', roomId);
            const roomDoc = await getDoc(roomRef);
            
            if (!roomDoc.exists()) {
                // First person - create room
                isOfferer = true;
                await setDoc(roomRef, { 
                    creator: userId, 
                    created: new Date(),
                    participants: [userId]
                });
                console.log('Created room as offerer');
            } else {
                // Second person - join existing room
                isOfferer = false;
                console.log('Joining existing room');
            }

            await createPeerConnection();
            setupRoomListener();
        }

        async function createPeerConnection() {
            peerConnection = new RTCPeerConnection(servers);
            
            // Add local stream
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            // Handle remote stream
            peerConnection.ontrack = event => {
                console.log('Received remote stream');
                // Only play remote audio, never local audio
                if (event.streams[0] !== localStream) {
                    const remoteAudio = document.createElement('audio');
                    remoteAudio.srcObject = event.streams[0];
                    remoteAudio.autoplay = true;
                    remoteAudio.playsInline = true;
                    remoteAudio.volume = 1.0;
                    
                    // Ensure audio plays
                    remoteAudio.play().then(() => {
                        console.log('Remote audio playing');
                    }).catch(error => {
                        console.error('Audio play failed:', error);
                        // Try to play on user interaction
                        document.addEventListener('click', () => {
                            remoteAudio.play();
                        }, { once: true });
                    });
                    
                    document.getElementById('remote-audio-container').appendChild(remoteAudio);
                    participantsCountEl.textContent = 'Participants: 2';
                }
            };

            // Handle ICE candidates
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    addDoc(collection(db, 'rooms', roomId, 'candidates'), {
                        candidate: event.candidate.toJSON(),
                        from: userId
                    });
                }
            };

            if (isOfferer) {
                // Create and send offer
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                await setDoc(doc(db, 'rooms', roomId, 'offers', userId), {
                    offer: { type: offer.type, sdp: offer.sdp },
                    from: userId
                });
            }
        }

        function setupRoomListener() {
            // Listen for offers (answerer only)
            if (!isOfferer) {
                onSnapshot(collection(db, 'rooms', roomId, 'offers'), snapshot => {
                    snapshot.docChanges().forEach(async change => {
                        if (change.type === 'added' && change.doc.data().from !== userId && !hasProcessedOffer) {
                            hasProcessedOffer = true;
                            const offer = change.doc.data().offer;
                            console.log('Answerer: Processing offer, state:', peerConnection.signalingState);
                            
                            if (peerConnection.signalingState === 'stable') {
                                try {
                                    await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                                    const answer = await peerConnection.createAnswer();
                                    await peerConnection.setLocalDescription(answer);
                                    
                                    await setDoc(doc(db, 'rooms', roomId, 'answers', userId), {
                                        answer: { type: answer.type, sdp: answer.sdp },
                                        from: userId
                                    });
                                    console.log('Answerer: Sent answer');
                                } catch (error) {
                                    console.error('Answerer error:', error);
                                    hasProcessedOffer = false;
                                }
                            }
                        }
                    });
                });
            }

            // Listen for answers (offerer only)
            if (isOfferer) {
                onSnapshot(collection(db, 'rooms', roomId, 'answers'), snapshot => {
                    snapshot.docChanges().forEach(async change => {
                        if (change.type === 'added' && change.doc.data().from !== userId && !hasProcessedAnswer) {
                            hasProcessedAnswer = true;
                            const answer = change.doc.data().answer;
                            console.log('Offerer: Processing answer, state:', peerConnection.signalingState);
                            
                            if (peerConnection.signalingState === 'have-local-offer') {
                                try {
                                    await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                                    console.log('Connection established!');
                                } catch (error) {
                                    console.error('Offerer error:', error);
                                    hasProcessedAnswer = false;
                                }
                            }
                        }
                    });
                });
            }

            // Listen for ICE candidates
            onSnapshot(collection(db, 'rooms', roomId, 'candidates'), snapshot => {
                snapshot.docChanges().forEach(async change => {
                    if (change.type === 'added' && change.doc.data().from !== userId) {
                        const candidate = change.doc.data().candidate;
                        if (peerConnection.remoteDescription) {
                            try {
                                await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                            } catch (error) {
                                console.error('ICE candidate error:', error);
                            }
                        }
                    }
                });
            });
        }

        async function hangUp() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            document.getElementById('remote-audio-container').innerHTML = '';
            participantsCountEl.textContent = 'Participants: 1';
            
            if (roomId) {
                try {
                    await deleteDoc(doc(db, 'rooms', roomId));
                } catch (error) {
                    console.log('Room cleanup error:', error);
                }
            }
            
            roomId = null;
            hasProcessedOffer = false;
            hasProcessedAnswer = false;
        }

        window.addEventListener('beforeunload', hangUp);
    </script>
</body>
</html>
